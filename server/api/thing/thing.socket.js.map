{"version":3,"sources":["api/thing/thing.socket.js"],"names":["register","activate","deActivate","events","thingConnections","socket","i","eventsLength","length","event","listener","createListener","on","removeListener","data","conn","find","findOne","macAddress","exec","then","doc","active","save","push","thingId","_id","catch","err","splice","findById","emit","findSocket"],"mappings":"AAAA;;;;AAIA;;;;;QAWgBA,Q,GAAAA,Q;QAWAC,Q,GAAAA,Q;QAeAC,U,GAAAA,U;;AAnChB;;;;AACA;;;;;;AAEA;AACA,IAAIC,SAAS,CAAC,MAAD,EAAS,QAAT,CAAb;;AAEA,IAAIC,mBAAiB,EAArB;;AAGO,SAASJ,QAAT,CAAkBK,MAAlB,EAA0B;AAC/B;AACA,OAAI,IAAIC,IAAI,CAAR,EAAWC,eAAeJ,OAAOK,MAArC,EAA6CF,IAAIC,YAAjD,EAA+DD,GAA/D,EAAoE;AAClE,QAAIG,QAAQN,OAAOG,CAAP,CAAZ;AACA,QAAII,WAAWC,0BAAwBF,KAAxB,EAAiCJ,MAAjC,CAAf;;AAEA,oBAAYO,EAAZ,CAAeH,KAAf,EAAsBC,QAAtB;AACAL,WAAOO,EAAP,CAAU,YAAV,EAAwBC,eAAeJ,KAAf,EAAsBC,QAAtB,CAAxB;AACD;AACF;;AAEM,SAAST,QAAT,CAAkBI,MAAlB,EAA0BS,IAA1B,EAAiC;AACtC,MAAIC,OAAOX,iBAAiBY,IAAjB,CAAsB;AAAA,WAAQD,KAAKV,MAAL,KAAgBA,MAAxB;AAAA,GAAtB,CAAX;AACA,MAAI,CAACU,IAAL,EAAY;AACR,oBAAME,OAAN,CAAc,EAAC,cAAcH,KAAKI,UAApB,EAAd,EAA+CC,IAA/C,GACGC,IADH,CACQ,UAASC,GAAT,EAAc;AAClBA,UAAIC,MAAJ,GAAa,IAAb;AACAD,UAAIE,IAAJ;AACAnB,uBAAiBoB,IAAjB,CAAsB,EAACC,SAAQJ,IAAIK,GAAb,EAAkBrB,QAAQA,MAA1B,EAAtB;AACD,KALH,EAMGsB,KANH,CAMS,UAASC,GAAT,EAAa;AAClBxB,uBAAiByB,MAAjB,CAAwBd,IAAxB;AACD,KARH;AASD;AACJ;;AAEM,SAASb,UAAT,CAAoBG,MAApB,EAA6B;AAClC,MAAIU,OAAOX,iBAAiBY,IAAjB,CAAsB;AAAA,WAAQD,KAAKV,MAAL,KAAgBA,MAAxB;AAAA,GAAtB,CAAX;AACA,MAAIU,IAAJ,EAAW;AACP,oBAAMe,QAAN,CAAef,KAAKU,OAApB,EAA6BN,IAA7B,GACGC,IADH,CACQ,UAASC,GAAT,EAAc;AAClBA,UAAIC,MAAJ,GAAa,KAAb;AACAD,UAAIE,IAAJ;AACAlB,aAAO0B,IAAP;AACA3B,uBAAiByB,MAAjB,CAAwBd,IAAxB;AACD,KANH,EAOGY,KAPH,CAOS,UAASC,GAAT,EAAa;AAClBxB,uBAAiByB,MAAjB,CAAwBd,IAAxB;AACD,KATH;AAUD;AACJ;;AAGD,SAASiB,UAAT,CAAoB3B,MAApB,EAA4B;AAC1B,SAAOD,iBAAiBC,MAAjB,KAA4BA,MAAnC;AACD;;AAED,SAASM,cAAT,CAAwBF,KAAxB,EAA+BJ,MAA/B,EAAuC;AACrC,SAAO,UAASgB,GAAT,EAAc;AACnBhB,WAAO0B,IAAP,CAAYtB,KAAZ,EAAmBY,GAAnB;AACD,GAFD;AAGD;;AAED,SAASR,cAAT,CAAwBJ,KAAxB,EAA+BC,QAA/B,EAAyC;AACvC,SAAO,YAAW;AAChB,oBAAYG,cAAZ,CAA2BJ,KAA3B,EAAkCC,QAAlC;AACD,GAFD;AAGD","file":"thing.socket.js","sourcesContent":["/**\r\n * Broadcast updates to client when the model changes\r\n */\r\n\r\n'use strict';\r\n\r\nimport ThingEvents from './thing.events';\r\nimport Thing from './thing.model';\r\n\r\n// Model events to emit\r\nvar events = ['save', 'remove'];\r\n\r\nvar thingConnections=[];\r\n\r\n\r\nexport function register(socket) {\r\n  // Bind model events to socket events\r\n  for(var i = 0, eventsLength = events.length; i < eventsLength; i++) {\r\n    var event = events[i];\r\n    var listener = createListener(`thing:${event}`, socket);\r\n\r\n    ThingEvents.on(event, listener);\r\n    socket.on('disconnect', removeListener(event, listener));\r\n  }\r\n}\r\n\r\nexport function activate(socket, data)  {\r\n  var conn = thingConnections.find(conn => conn.socket === socket);\r\n  if (!conn)  {\r\n      Thing.findOne({'macAddress': data.macAddress}).exec()\r\n        .then(function(doc) {\r\n          doc.active = true;\r\n          doc.save();\r\n          thingConnections.push({thingId:doc._id, socket: socket});\r\n        })\r\n        .catch(function(err){\r\n          thingConnections.splice(conn);\r\n        });\r\n    }\r\n}\r\n\r\nexport function deActivate(socket)  {\r\n  let conn = thingConnections.find(conn => conn.socket === socket);\r\n  if (conn)  {\r\n      Thing.findById(conn.thingId).exec()\r\n        .then(function(doc) {\r\n          doc.active = false;\r\n          doc.save();\r\n          socket.emit()\r\n          thingConnections.splice(conn);\r\n        })\r\n        .catch(function(err){\r\n          thingConnections.splice(conn);\r\n        });\r\n    }\r\n}\r\n\r\n\r\nfunction findSocket(socket) {\r\n  return thingConnections.socket === socket;\r\n}\r\n\r\nfunction createListener(event, socket) {\r\n  return function(doc) {\r\n    socket.emit(event, doc);\r\n  };\r\n}\r\n\r\nfunction removeListener(event, listener) {\r\n  return function() {\r\n    ThingEvents.removeListener(event, listener);\r\n  };\r\n}\r\n"]}